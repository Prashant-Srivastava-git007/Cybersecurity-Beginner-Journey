# 🔐 pfSense Configuration for Cybersecurity Lab

This guide explains how to configure **pfSense Firewall** after installing it.  
The goal is to create:
- 🖥️ **Target LAN** (Windows 11 target machine)
- ⚔️ **Attack LAN** (Kali Linux attacker machine)
- 🌐 **WAN** connection (pfSense linked to the internet)

---

## 🌐 Network Diagram

Below is a simple diagram of the lab setup:

          🌍 Internet
              │
              │
          ┌──────────┐
          │  WAN     │ (Bridged Adapter)
          │ pfSense  │ 10.0.1.1
          └──────────┘
         /             \
        /               \
    ┌────────────────┐ ┌────────────────┐
    │ Target LAN     │ │ Attack LAN     │
    │ Windows 11     │ │ Kali Linux     │
    │ IP: 10.0.1.2   │ │ IP: 10.0.3.x   │
    └────────────────┘ └────────────────┘
  
- **WAN:** Connects pfSense to your real home/office network for internet access.
- **Target LAN (10.0.1.x):** Contains Windows 11 VM (the victim network).
- **Attack LAN (10.0.3.x):** Contains Kali Linux VM (used for penetration testing).
- pfSense acts as a **router + firewall** between these networks.

---

## 🌍 Step 1: Access pfSense Web Interface
1. On your **Windows 11 VM**, open **Microsoft Edge**.
2. Enter the pfSense firewall IP:  
```
https://10.0.1.1
```

3. A warning appears (because pfSense uses a self-signed certificate).  
- Click **Advanced → Accept the Risk & Continue**.
4. Login using default credentials:  
- **Username:** `admin`  
- **Password:** `pfsense`

---

## ⚙️ Step 2: Initial Setup Wizard
- Click **Next → Next**.
- (Optional) Change the **Hostname** and **Domain** if you wish.
- **Uncheck:** “Override DNS” → Click **Next**.
- Change the **Time Zone** → Click **Next**.
- Scroll down and **Uncheck:** “Block RFC1918 Private Networks” → Click **Next**.  
*(We uncheck this so our private lab networks can communicate.)*
- Leave other values as default → Click **Next**.
- Change the **Admin Password** → Click **Next → Reload → Finish → Close**.

---

## 🏷️ Step 3: Rename Interfaces
1. Go to **Interfaces → LAN**:
- Change description to: `Target LAN` → **Save → Apply Changes**.
2. Go to **Interfaces → OPT1**:
- Change description to: `Attack LAN` → **Save → Apply Changes**.

---

## 🌐 Step 4: Configure DNS Resolver
1. Go to **Services → DNS Resolver**.
2. Scroll to the bottom:
- ✅ Check **DHCP Registration**.
- ✅ Check **Static DHCP**.
3. Scroll up → Click **Advanced Settings**.
4. Enable:
- ✅ **Prefetch Support**
- ✅ **Prefetch DNS Key Support**
5. Scroll down → **Save → Apply Changes**.

✅ *This ensures pfSense resolves DNS queries quickly for both LANs.*

---

## ⚡ Step 5: Networking Optimization
1. Go to **System → Advanced → Networking**.
2. Enable **Hardware Checksum Offloading** → **Save → OK**.
3. Login again with the new password (if prompted).

---

## 📜 Step 6: DHCP Leases (Assigning IPs)
1. Go to **Status → DHCP Leases**.
2. Find the IP assigned to **Windows 11 VM**.
3. Click the **+ (Add)** icon under **Actions**.
4. Set IP to: `10.0.1.2` → **Save → Apply Changes**.
5. On Windows 11, open **Command Prompt**:
```bash
ipconfig /release
ipconfig /renew
```

✅ We assigned a fixed IP to keep the target machine consistent for scans and attacks.

## 🆔 Step 7: Create an Alias for Private IPs
1. Go to Firewall → Aliases → Add.
2. Fill in the following:
   - Name: RFC1918
   - Description: Private IPv4 Address Space
   - Type: Network
3. Add these ranges:

   ```
    10.0.0.0/8
    172.16.0.0/12
    192.168.0.0/24
   ```

4. Save → Apply Changes.
✅ Aliases group private IP ranges so we can create firewall rules more easily.

---

## 🔥 Step 8: Create Firewall Rules
🔑 Important:
pfSense applies rules Top → Down.

👉 The first rule that matches traffic takes effect.


### 8.1 Target LAN Rules

These rules control traffic for the Target LAN (Windows 11).

✅ Rule 1: Allow Internal Traffic
- Action: Pass
- Interface: Target LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Target LAN
- Destination: Target LAN
- Description: Allow traffic to all devices within Target LAN

➡️ Reason: Devices inside the Target LAN must communicate freely.


✅ Rule 2: Allow Target ↔ Attack LAN Communication
- Action: Pass
- Interface: Target LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Target LAN
- Destination: Attack LAN
- Description: Allow communication between Target LAN and Attack LAN

➡️ Reason: This lets the attacker machine (Kali) interact with the target (Windows 11) for testing.


✅ Rule 3: Allow Target LAN Internet Access
- Action: Pass
- Interface: Target LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Target LAN
- Destination: Address or Alias → RFC1918 (Invert Match ✅)
- Description: Allow traffic to non-private (Internet)

➡️ Reason: Allows the target machine to reach the internet while blocking private subnets.

🚫 Rule 4: Block Everything Else
- Action: Block
- Interface: Target LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Target LAN
- Destination: Any
- Description: Block all unspecified traffic

➡️ Reason: A default block rule for extra security.

---

### 8.2 Attack LAN Rules

These rules control traffic for the Attack LAN (Kali).

✅ Rule 1: Allow Attack LAN → Target LAN
- Action: Pass
- Interface: Attack LAN
- Address Family: IPv4
- Protocol: Any
- Source: Attack LAN
- Destination: Target LAN
- Description: Allow traffic from Attack LAN to Target LAN

➡️ Reason: Kali needs access to the target machine to run tests.

🚫 Rule 2: Block Attack LAN Internet Access
- Action: Block
- Interface: Attack LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Attack LAN
- Destination: Address or Alias → RFC1918 (Invert Match ✅)
- Description: Block internet access from Attack LAN

➡️ Reason: Prevents the attacker machine from reaching the internet for safety.
> 👉 If you ever need internet on Kali (e.g., to update tools), you’ll have to temporarily disable this rule.

🚫 Rule 3: Block Attack LAN → WAN Subnets
- Action: Block
- Interface: Attack LAN
- Address Family: IPv4+IPv6
- Protocol: Any
- Source: Attack LAN
- Destination: WAN Subnets
- Description: Block traffic from Attack LAN to WAN

➡️ Reason: Prevents the attacker machine from interfering with WAN networks.

---

## 🔄 Step 9: Final Step – Reboot pfSense

Go to Diagnostics → Reboot → Normal Reboot → Submit.

✅ pfSense is now fully configured for your lab environment.

---

## 📝 Summary
- 🟢 Target LAN (Windows 11) can reach the internet and communicate with Attack LAN.
- 🔴 Attack LAN (Kali) can only reach Target LAN (no internet).
- 🔒 All other traffic is blocked for security.

This configuration simulates a real-world segmented network for practicing:
- 🛡️ Firewall management
- 🔥 Rule-based network security
- ⚔️ Penetration testing scenarios

---
