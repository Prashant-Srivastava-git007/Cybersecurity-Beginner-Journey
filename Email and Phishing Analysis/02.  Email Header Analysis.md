# 📧 Email Header Analysis

## 🧰 Lab Setup

To analyze phishing and legitimate emails, let’s set up a small lab using **Thunderbird** and **Sublime Text**.

### 🔹 Step 1 – Install Thunderbird
Download and install the **Thunderbird email client** on your Windows machine:  
👉 [Thunderbird — Free Your Inbox](https://www.thunderbird.net)

This will help you open and inspect `.eml` files (email files).

### 🔹 Step 2 – Install Sublime Text
Download and install **Sublime Text**:  
👉 [Sublime Text](https://www.sublimetext.com)

It’s a lightweight text editor perfect for viewing and analyzing email headers.

### 🔹 Step 3 – Add the Email Header Plugin
1. Open Sublime Text → Go to **Tools → Install Package Control**.  
2. Press **Ctrl + Shift + P**, type `install`, and select **Package Control: Install Package**.  
3. In the next prompt, search for **Email Header**.  
4. Visit the plugin’s GitHub page and download the latest release.  
5. Extract it and copy the file `EmailHeader.sublime-syntax` into: `C:\Users<YourUsername>\AppData\Roaming\Sublime Text\Packages\User`
6. Restart Sublime Text and open any `.eml` file → select **email** in the bottom-right corner.  
You’ll now see a **nicely formatted header view**.

---

## 📬 How Email Works 

1. **Sending Email:** You compose a message in Gmail, Outlook, or Thunderbird and click “Send.”  
2. **SMTP Server:** The email is sent via **SMTP (Simple Mail Transfer Protocol)**.  
3. **DNS Lookup:** The sender’s server checks DNS records to find the recipient’s mail server.  
4. **Delivery:** The email is sent over the Internet to the recipient’s server.  
5. **Receiving:** The recipient downloads it using **IMAP** or **POP3**.  
- **IMAP:** Keeps a copy on the server (useful across multiple devices).  
- **POP3:** Downloads and removes it from the server.  
6. **Reading:** The recipient opens and reads the message.  
7. **Security:** Encryption (TLS/SSL) helps secure the communication.

---

## ✉️ SMTP in a Nutshell

**SMTP (Simple Mail Transfer Protocol)** is how emails are sent across the internet.

- It’s a **push protocol**, transferring mail directly from sender to receiver.  
- Uses commands and responses to handle email delivery.  
- By default, SMTP isn’t encrypted — so **TLS** is used to add security.

---

## 🔍 Email Header Analysis

Email headers contain **hidden metadata** that reveal where an email came from and how it traveled.

### Why It’s Important
Analyzing headers helps identify:
- Spoofed senders  
- Phishing attempts  
- Fake domains  
- Message tampering  

---

### 🧩 Key Header Fields (Legitimate Email Example)

| Field | Description | Example |
|-------|--------------|----------|
| **Delivered-To** | Final recipient’s email address | `user@gmail.com` |
| **Received** | Each server that handled the email (shows IP and timestamp) | `Received: from marketing.crowdstrike.com (192.28.150.219)` |
| **Return-Path** | Address used for bounce replies | `281-OBQ@marketing.crowdstrike.com` |
| **SPF / DKIM / DMARC** | Authentication checks to verify legitimacy | `spf=pass dkim=pass dmarc=pass` |
| **From** | Sender’s email | `communications@crowdstrike.com` |
| **Message-ID** | Unique ID for tracking | `<131447797.706232022@marketo.org>` |
| **Subject** | Email’s title | `Join George Kurtz for Hits and Highlights from Fal.Con 2024` |

✅ **Legitimate emails** have consistent details — matching domains, valid authentication, and logical server paths.

---

## 🔒 Email Authentication Methods

| Method | Purpose | How It Works |
|---------|----------|---------------|
| **SPF (Sender Policy Framework)** | Confirms the sender’s IP is allowed to send emails for that domain. | Uses a TXT record in DNS to verify. |
| **DKIM (DomainKeys Identified Mail)** | Ensures the message wasn’t altered. | Uses a digital signature linked to the sender’s domain. |
| **DMARC (Domain-based Message Authentication)** | Combines SPF + DKIM to enforce policies. | Tells receiving servers how to handle failed messages. |

🧠 Example command to check SPF record:
```bash
nslookup -type=txt crowdstrike.com | grep -i spf
```

---

## ⚠️ Phishing Email Example 

| Header                                                   | Red Flag                                    |
| -------------------------------------------------------- | ------------------------------------------- |
| **Return-Path:** `<admin@sec-ecorp.com>`                 | Domain slightly altered from `ecorp.com`    |
| **Received:** from `suspicious-mail.com (198.51.100.25)` | Not an authorized mail server               |
| **DKIM-Signature:** `sec-ecorp.com`                      | Doesn’t match legitimate domain             |
| **SPF / DKIM / DMARC:** Fail                             | Authentication fails → email likely spoofed |
| **Subject:** “Urgent: Review Your Executive Account”     | Uses fear and urgency                       |
| **Message-ID:** `@suspicious-mail.com`                   | Doesn’t match sending domain                |

> 📉 These clues clearly show it’s a phishing attempt.

---

## 🧪 Practical Tips for Email Header Analysis
* Check "Received" lines: Trace email’s path — the first line (bottom-most) shows the original sender.
* Match domains: Ensure “From”, “Return-Path”, and “Received” all align.
* Look for authentication results: SPF, DKIM, and DMARC should pass.
* Watch timestamps: Odd time zones or delays can indicate spoofing.
* Use Tools:
    * [MX Toolbox](https://mxtoolbox.com/EmailHeaders.aspx)
    * Microsoft Header Analyzer

---

## 📌 Summary
* Email headers are your first line of defense against phishing.
* Check SPF, DKIM, and DMARC results.
* Look for inconsistencies in domains and IPs.
* Never trust emails with urgency, mismatched domains, or failed authentication.

---
