# ğŸ“§ Email Header Analysis

## ğŸ§° Lab Setup

To analyze phishing and legitimate emails, letâ€™s set up a small lab using **Thunderbird** and **Sublime Text**.

### ğŸ”¹ Step 1 â€“ Install Thunderbird
Download and install the **Thunderbird email client** on your Windows machine:  
ğŸ‘‰ [Thunderbird â€” Free Your Inbox](https://www.thunderbird.net)

This will help you open and inspect `.eml` files (email files).

### ğŸ”¹ Step 2 â€“ Install Sublime Text
Download and install **Sublime Text**:  
ğŸ‘‰ [Sublime Text](https://www.sublimetext.com)

Itâ€™s a lightweight text editor perfect for viewing and analyzing email headers.

### ğŸ”¹ Step 3 â€“ Add the Email Header Plugin
1. Open Sublime Text â†’ Go to **Tools â†’ Install Package Control**.  
2. Press **Ctrl + Shift + P**, type `install`, and select **Package Control: Install Package**.  
3. In the next prompt, search for **Email Header**.  
4. Visit the pluginâ€™s GitHub page and download the latest release.  
5. Extract it and copy the file `EmailHeader.sublime-syntax` into: `C:\Users<YourUsername>\AppData\Roaming\Sublime Text\Packages\User`
6. Restart Sublime Text and open any `.eml` file â†’ select **email** in the bottom-right corner.  
Youâ€™ll now see a **nicely formatted header view**.

---

## ğŸ“¬ How Email Works 

1. **Sending Email:** You compose a message in Gmail, Outlook, or Thunderbird and click â€œSend.â€  
2. **SMTP Server:** The email is sent via **SMTP (Simple Mail Transfer Protocol)**.  
3. **DNS Lookup:** The senderâ€™s server checks DNS records to find the recipientâ€™s mail server.  
4. **Delivery:** The email is sent over the Internet to the recipientâ€™s server.  
5. **Receiving:** The recipient downloads it using **IMAP** or **POP3**.  
- **IMAP:** Keeps a copy on the server (useful across multiple devices).  
- **POP3:** Downloads and removes it from the server.  
6. **Reading:** The recipient opens and reads the message.  
7. **Security:** Encryption (TLS/SSL) helps secure the communication.

---

## âœ‰ï¸ SMTP in a Nutshell

**SMTP (Simple Mail Transfer Protocol)** is how emails are sent across the internet.

- Itâ€™s a **push protocol**, transferring mail directly from sender to receiver.  
- Uses commands and responses to handle email delivery.  
- By default, SMTP isnâ€™t encrypted â€” so **TLS** is used to add security.

---

## ğŸ” Email Header Analysis

Email headers contain **hidden metadata** that reveal where an email came from and how it traveled.

### Why Itâ€™s Important
Analyzing headers helps identify:
- Spoofed senders  
- Phishing attempts  
- Fake domains  
- Message tampering  

---

### ğŸ§© Key Header Fields (Legitimate Email Example)

| Field | Description | Example |
|-------|--------------|----------|
| **Delivered-To** | Final recipientâ€™s email address | `user@gmail.com` |
| **Received** | Each server that handled the email (shows IP and timestamp) | `Received: from marketing.crowdstrike.com (192.28.150.219)` |
| **Return-Path** | Address used for bounce replies | `281-OBQ@marketing.crowdstrike.com` |
| **SPF / DKIM / DMARC** | Authentication checks to verify legitimacy | `spf=pass dkim=pass dmarc=pass` |
| **From** | Senderâ€™s email | `communications@crowdstrike.com` |
| **Message-ID** | Unique ID for tracking | `<131447797.706232022@marketo.org>` |
| **Subject** | Emailâ€™s title | `Join George Kurtz for Hits and Highlights from Fal.Con 2024` |

âœ… **Legitimate emails** have consistent details â€” matching domains, valid authentication, and logical server paths.

---

## ğŸ”’ Email Authentication Methods

| Method | Purpose | How It Works |
|---------|----------|---------------|
| **SPF (Sender Policy Framework)** | Confirms the senderâ€™s IP is allowed to send emails for that domain. | Uses a TXT record in DNS to verify. |
| **DKIM (DomainKeys Identified Mail)** | Ensures the message wasnâ€™t altered. | Uses a digital signature linked to the senderâ€™s domain. |
| **DMARC (Domain-based Message Authentication)** | Combines SPF + DKIM to enforce policies. | Tells receiving servers how to handle failed messages. |

ğŸ§  Example command to check SPF record:
```bash
nslookup -type=txt crowdstrike.com | grep -i spf
```

---

## âš ï¸ Phishing Email Example 

| Header                                                   | Red Flag                                    |
| -------------------------------------------------------- | ------------------------------------------- |
| **Return-Path:** `<admin@sec-ecorp.com>`                 | Domain slightly altered from `ecorp.com`    |
| **Received:** from `suspicious-mail.com (198.51.100.25)` | Not an authorized mail server               |
| **DKIM-Signature:** `sec-ecorp.com`                      | Doesnâ€™t match legitimate domain             |
| **SPF / DKIM / DMARC:** Fail                             | Authentication fails â†’ email likely spoofed |
| **Subject:** â€œUrgent: Review Your Executive Accountâ€     | Uses fear and urgency                       |
| **Message-ID:** `@suspicious-mail.com`                   | Doesnâ€™t match sending domain                |

> ğŸ“‰ These clues clearly show itâ€™s a phishing attempt.

---

## ğŸ§ª Practical Tips for Email Header Analysis
* Check "Received" lines: Trace emailâ€™s path â€” the first line (bottom-most) shows the original sender.
* Match domains: Ensure â€œFromâ€, â€œReturn-Pathâ€, and â€œReceivedâ€ all align.
* Look for authentication results: SPF, DKIM, and DMARC should pass.
* Watch timestamps: Odd time zones or delays can indicate spoofing.
* Use Tools:
    * [MX Toolbox](https://mxtoolbox.com/EmailHeaders.aspx)
    * Microsoft Header Analyzer

---

## ğŸ“Œ Summary
* Email headers are your first line of defense against phishing.
* Check SPF, DKIM, and DMARC results.
* Look for inconsistencies in domains and IPs.
* Never trust emails with urgency, mismatched domains, or failed authentication.

---
